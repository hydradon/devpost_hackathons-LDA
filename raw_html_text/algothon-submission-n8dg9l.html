<html>
    <head>
    </head>
    <body>
        <div class="large-9 columns" id="app-details-left">
            <div>
                <p>
                    Sean - generated signals and stock data for backtests
Jianbo - ran back tests and generated results
Xavier - Did research on strategies to include
                </p>
                <p>
                    Code:
                </p>
                <p>
                    library(tidyverse)
library(magrittr)
library(Quandl)
library(moments)
library(data.table)
                </p>
                <p>
                    snp &lt;- read.csv("Adjusted_close_prices.csv")
                </p>
                <p>
                    colnames(snp)[1] &lt;- "Date"
snp$Date &lt;- as.Date(snp$Date)
snp_melted &lt;- snp %&gt;% melt(id = "Date")
colnames(snp_melted) &lt;- c("Date", "Stock", "Price")
snp_tidy &lt;- snp_melted %&gt;% group_by(Date) %&gt;%
mutate(exist = ifelse(is.na(Price) == 1, 0, 1)) %&gt;%
filter(sum(exist) &gt; 10)
                </p>
                <h1>
                    snp_tidy &lt;- snp_melted %&gt;%
                </h1>
                <h1>
                    na.fill(0) %&gt;% as.data.frame
                </h1>
                <h1>
                    snp_tidy$Price &lt;- as.numeric(as.character(snp_tidy$Price))
                </h1>
                <p>
                    snp_tidy &lt;- snp_tidy %&gt;% group_by(Stock) %&gt;%
    mutate(Price = na.locf(Price, na.rm = F))
snp_tidy &lt;- snp_tidy %&gt;% 
group_by(Stock) %&gt;%
mutate(past_price = shift(Price)) %&gt;%
mutate(returns = (Price - past_price)/past_price, tcost = 0.0005)
snp_tidy$Date &lt;- as.Date(snp_tidy$Date)
                </p>
                <p>
                    snp500 &lt;- read.csv("Adjusted_close_prices_with_SnP_index.csv") %&gt;% select(1,102)
snp500 &lt;- snp500 %&gt;%
mutate(SnP500 = na.locf(SnP500, na.rm = F)) %&gt;%
mutate(snp500_past = shift(SnP500)) %&gt;%
mutate(snp500 = (SnP500 - snp500_past)/snp500_past)
                </p>
                <p>
                    stocks &lt;- colnames(snp)
stocks &lt;- stocks[-1]
y &lt;- data.frame(matrix(nrow = 0, ncol = 10))
colnames(y) &lt;- c("datekey","ticker", "de", "divyield","marketcap", "ncfo", "netmargin","payoutratio","pb","pe1")
for(i in stocks){
Quandl.api_key("Tu_djozePNhyxDs1ij4C")
a &lt;- Quandl.datatable('SHARADAR/SF1', ticker=i)
a &lt;- a %&gt;% filter(dimension == "ARQ") %&gt;%
select("datekey","ticker", "de", "divyield","marketcap", "ncfo", "netmargin","payoutratio","pb","pe1")
y &lt;- rbind(y,a)
                </p>
                <p>
                    }
colnames(y) &lt;- c("Date", "Stock", "de", "divyield","marketcap", "ncfo", "netmargin","payoutratio","pb","pe1")
                </p>
                <p>
                    snp_use &lt;- snp_tidy %&gt;% left_join(y, by= c("Date","Stock"))
snp_use &lt;- snp_use %&gt;% group_by(Stock) %&gt;%
mutate(vol =  rollapply(returns, width = 250, FUN= sd, fill = NA, align = "right"))
snp_use[,8:16] &lt;- na.locf(snp_use[,8:16], na.rm = F)
                </p>
                <p>
                    calculate_cost &lt;- function(x){
    x &lt;- x %&gt;% group_by(Date) %&gt;%
    mutate(weight_drift = (weight*(1+returns))/(1+sum(weight * returns, na.rm = T))) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight_drift = shift(weight_drift)) %&gt;%
    mutate(turnover = abs(weight - weight_drift)) %&gt;%
    mutate(cost = tcost * turnover)
}
                </p>
                <p>
                    gen_returns &lt;- function(x){
    x &lt;- x %&gt;% group_by(Date) %&gt;%
    mutate(daily_ret = weight * returns - cost) %&gt;%
    mutate(precost = weight * returns) %&gt;%
    summarise(Return = sum(daily_ret, na.rm = T), precost = sum(precost, na.rm = T)) %&gt;%
    mutate(Return = na.fill(Return,0))
}
                </p>
                <p>
                    gen_stats &lt;- function(x){
   x %&gt;% summarise(SR = mean(x$Return, na.rm = T)/sd(x$Return, na.rm = T)
                    <em>
                        sqrt(252),
                        mean = mean(x$Return, na.rm = T)*252, Vol = sd(x$Return, na.rm = T)*sqrt(252),
                        <br>
                        precostSR = mean(x$precost, na.rm = T)/sd(x$precost, na.rm = T)
                    </em>
                    sqrt(252),
                    precostmean = mean(x$precost, na.rm = T)*252 )
}
                </p>
                <p>
                    gen_debtratio_wts &lt;- function(data){
    data &lt;- data %&gt;% filter(exist == 1) %&gt;%
    group_by(Date) %&gt;%
    mutate(debt = rank(abs(de), na.last = "keep")) %&gt;%
    mutate(weight = ifelse(debt &lt;= 0.2*sum(exist, na.rm = T), -1, ifelse(debt &gt;= 0.8*sum(exist, na.rm = T), 1, 0))) %&gt;%
    #mutate(weight = debt - median(debt, na.rm = T)) %&gt;%
    mutate(weight = weight/vol) %&gt;%
    mutate(weight = weight/sum(abs(weight), na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight, 3))%&gt;%
    ungroup() %&gt;%
    mutate(strat = "debtratio")
                </p>
                <p>
                    }
                </p>
                <p>
                    debtratio_wts &lt;- gen_debtratio_wts(snp_use)
debtratio_cost &lt;- calculate_cost(debtratio_wts)
debtratio_returns &lt;- gen_returns(debtratio_cost)
gen_stats(debtratio_returns)
                </p>
                <p>
                    gen_size_wts &lt;- function(data){
    data &lt;- data %&gt;% filter(exist == 1) %&gt;%
    group_by(Date) %&gt;%
    mutate(size = rank(abs(marketcap), na.last = "keep")) %&gt;%
    mutate(weight = ifelse(size &lt;= 0.2*sum(exist, na.rm = T), 1, ifelse(size &gt;= 0.8*sum(exist, na.rm = T), -1, 0))) %&gt;%
    #mutate(weight = size - median(size, na.rm = T)) %&gt;%
    mutate(weight = weight/vol) %&gt;%
    mutate(weight = weight/sum(abs(weight), na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight, 3))%&gt;%
    ungroup() %&gt;%
    mutate(strat = "size")
                </p>
                <p>
                    }
                </p>
                <p>
                    size_wts &lt;- gen_size_wts(snp_use)
size_cost &lt;- calculate_cost(size_wts)
size_returns &lt;- gen_returns(size_cost)
gen_stats(size_returns)
                </p>
                <p>
                    gen_payout_wts &lt;- function(data){
    data &lt;- data %&gt;% filter(exist == 1) %&gt;%
    group_by(Date) %&gt;%
    mutate(payout = rank(abs(payoutratio), na.last = "keep")) %&gt;%
    mutate(weight = ifelse(payout &lt;= 0.2*sum(exist, na.rm = T), 1, ifelse(payout &gt;= 0.8*sum(exist, na.rm = T), -1, 0))) %&gt;%
    #mutate(weight = median(payout, na.rm = T) - payout) %&gt;%
    mutate(weight = weight/vol) %&gt;%
    mutate(weight = weight/sum(abs(weight), na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight, 3))%&gt;%
    ungroup() %&gt;%
    mutate(strat = "payout")
                </p>
                <p>
                    }
                </p>
                <p>
                    payout_wts &lt;- gen_payout_wts(snp_use)
payout_cost &lt;- calculate_cost(payout_wts)
payout_returns &lt;- gen_returns(payout_cost)
gen_stats(payout_returns)
                </p>
                <p>
                    gen_mom_wts &lt;- function(data){
    data &lt;- data %&gt;% filter(exist == 1) %&gt;%
    group_by(Stock) %&gt;%
    mutate(mom = rollapply(returns, width = 250, FUN = function(x) mean(x)/sd(x), fill = NA, align = "right")) %&gt;% 
    group_by(Date) %&gt;%
    mutate(rank = rank(abs(mom), na.last = "keep")) %&gt;%
    mutate(weight = ifelse(rank &lt;= 0.2*sum(exist, na.rm = T), -1, ifelse(rank &gt;= 0.8*sum(exist, na.rm = T), 1, 0))) %&gt;%
    mutate(weight = mom/vol) %&gt;%
    mutate(weight = weight/sum(abs(weight), na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight, 3))%&gt;%
    ungroup() %&gt;%
    mutate(strat = "mom")
                </p>
                <p>
                    }
                </p>
                <p>
                    mom_wts &lt;- gen_mom_wts(snp_use)
mom_cost &lt;- calculate_cost(mom_wts)
mom_returns &lt;- gen_returns(mom_cost)
gen_stats(mom_returns)
                </p>
                <p>
                    gen_trend_wts &lt;- function(data){
    data &lt;- data %&gt;% filter(exist == 1) %&gt;%
    group_by(Stock) %&gt;%
    mutate(longmom = rollapply(returns, width = 250, FUN = function(x) mean(x)/sd(x), fill = NA, align = "right")) %&gt;% 
    mutate(shortmom = rollapply(returns, width = 21, FUN = function(x) mean(x)/sd(x), fill = NA, align = "right")) %&gt;% 
    group_by(Date) %&gt;%
    mutate(weight = ifelse(shortmom &gt; longmom, 1, -1)) %&gt;%
    mutate(weight = weight/vol) %&gt;%
    mutate(weight = weight/sum(abs(weight), na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight, 3))%&gt;%
    ungroup() %&gt;%
    mutate(strat = "trend")
                </p>
                <p>
                    }
                </p>
                <p>
                    trend_wts &lt;- gen_trend_wts(snp_use)
trend_cost &lt;- calculate_cost(trend_wts)
trend_returns &lt;- gen_returns(trend_cost)
gen_stats(trend_returns)
                </p>
                <p>
                    snpbeta &lt;- read.csv("tidy_Beta.csv")
colnames(snpbeta) &lt;- c("X", "Date", "Stock", "Beta")
snpbeta &lt;- snpbeta %&gt;% group_by(Stock) %&gt;%
mutate(Beta = na.locf(Beta, na.rm = F), Date = as.Date(Date)) %&gt;%
select(Date, Stock, Beta)
                </p>
                <p>
                    snpalpha &lt;- read.csv("tidy_ST_Alpha.csv") %&gt;% select(2:4)
colnames(snpalpha) &lt;- c("Date", "Stock", "STalpha")
snpalpha1 &lt;- read.csv("tidy_LT_Alpha.csv") %&gt;% select(2:4)
colnames(snpalpha1) &lt;- c("Date", "Stock", "LTalpha")
snpalpha &lt;- snpalpha %&gt;% left_join(snpalpha1, by = c("Date", "Stock")) %&gt;% group_by(Stock) %&gt;%
mutate(STalpha = na.locf(STalpha, na.rm = F), Date = as.Date(Date), LTalpha = na.locf(LTalpha, na.rm = F))
                </p>
                <p>
                    gen_bab_wts &lt;- function(x,y){
    x &lt;- x %&gt;% left_join(y, by = c("Date", "Stock"))
    x &lt;- x %&gt;% filter(exist == 1) %&gt;% group_by(Date) %&gt;% 
    mutate(Beta = na.locf(Beta, na.rm = F)) %&gt;%
    mutate(rank = rank(Beta, na.last = "keep")) %&gt;%
    mutate(weight = ifelse(rank &lt;= 0.2*sum(exist, na.rm = T), -1, ifelse(rank &gt;= 0.8*sum(exist, na.rm = T), 1, 0))) %&gt;%
    mutate(weight = weight/vol) %&gt;%
    mutate(weight = weight/sum(abs(weight))) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight,3)) %&gt;%
    ungroup() %&gt;%
    mutate(strat = "bab")
                </p>
                <p>
                    }
                </p>
                <p>
                    bab_wts &lt;- gen_bab_wts(snp_use, snpbeta)
bab_cost &lt;- calculate_cost(bab_wts)
bab_returns &lt;- gen_returns(bab_cost)
gen_stats(bab_returns)
                </p>
                <p>
                    gen_baa_wts &lt;- function(x,y){
    x &lt;- x %&gt;% left_join(y, by = c("Date", "Stock"))
    x &lt;- x %&gt;% filter(exist == 1) %&gt;% group_by(Stock) %&gt;%
    mutate(STalpha = na.locf(STalpha, na.rm = F), LTalpha = na.locf(LTalpha, na.rm = F)) %&gt;%
    ungroup() %&gt;% group_by(Date) %&gt;%
    mutate(ltrank = rank(LTalpha, na.last = "keep")) %&gt;%
    mutate(sign = ifelse(ltrank &lt;= 0.3*sum(exist, na.rm = T), -1, ifelse(ltrank &gt;= 0.7*sum(exist, na.rm = T), 1, NA))) %&gt;%
    filter(sign == 1 | sign == -1) %&gt;% 
    group_by(Date, sign) %&gt;% 
    mutate(strank = rank(STalpha, na.last = "keep")) %&gt;% 
    mutate(weight = ifelse(sign == 1 &amp; strank &lt;= 0.3*sum(exist, na.rm = T), 1, ifelse(sign == -1 &amp; strank &gt;= 0.7*sum(exist, na.rm = T), -1, 0))) %&gt;%
    mutate(weight = weight/vol) %&gt;%
    #mutate(weight = weight/sum(abs(weight)+0.0000000001, na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Date) %&gt;%
    mutate(weight = weight/sum(abs(weight)+0.0000000001, na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight,3)) %&gt;%
    ungroup() %&gt;%
    mutate(strat = "baa")
                </p>
                <p>
                    }
                </p>
                <p>
                    baa_wts &lt;- gen_baa_wts(snp_use, snpalpha)
baa_cost &lt;- calculate_cost(baa_wts)
baa_returns &lt;- gen_returns(baa_cost)
gen_stats(baa_returns)
                </p>
                <p>
                    gen_stats(mom_returns)
gen_stats(debtratio_returns)
gen_stats(payout_returns)
gen_stats(bab_returns)
                </p>
                <p>
                    mom_returns1 &lt;- mom_returns %&gt;%
    mutate(vol = rollapply(Return, width = 250, FUN= sd, fill = NA, align = "right")) %&gt;%
    mutate(sweight = 1/vol, strat = "mom")
debtratio_returns1 &lt;- mom_returns %&gt;%
mutate(vol = rollapply(Return, width = 250, FUN= sd, fill = NA, align = "right")) %&gt;%
mutate(sweight = 0.2/vol, strat = "debtratio")
payout_returns1 &lt;- mom_returns %&gt;%
mutate(vol = rollapply(Return, width = 250, FUN= sd, fill = NA, align = "right")) %&gt;%
mutate(sweight = 0.2/vol, strat = "payout")
bab_returns1 &lt;- mom_returns %&gt;%
mutate(vol = rollapply(Return, width = 250, FUN= sd, fill = NA, align = "right")) %&gt;%
mutate(sweight = 0.2/vol, strat = "bab")
                </p>
                <p>
                    stratreturns &lt;- rbind(mom_returns1, debtratio_returns1, payout_returns1, bab_returns1)
mom_wts1 &lt;- mom_wts %&gt;% select(Date, Stock, returns, weight, strat)
debtratio_wts1 &lt;- debtratio_wts %&gt;% select(Date, Stock, returns, weight, strat)
payout_wts1 &lt;- payout_wts %&gt;% select(Date, Stock, returns, weight, strat)
bab_wts1 &lt;- bab_wts %&gt;% select(Date, Stock, returns, weight, strat)
stratwts &lt;- rbind(mom_wts1, debtratio_wts1, payout_wts1, bab_wts1)
stratwts &lt;- stratwts %&gt;% left_join(stratreturns, by = c("Date", "strat")) %&gt;%
mutate(weight = weight * sweight) %&gt;% group_by(Date, Stock) %&gt;%
summarise(weight = sum(weight, na.rm = T), tcost = 0.0005, returns =mean(returns, na.rm = T)) %&gt;%
ungroup() %&gt;% group_by(Date) %&gt;%
mutate(weight = weight/sum(abs(weight),na.rm = T))
                </p>
                <p>
                    stratcost &lt;- calculate_cost(stratwts)
strat_ret &lt;- gen_returns(stratcost)
gen_stats(strat_ret%&gt;% filter(Date &gt; "1980-01-01"))
                </p>
                <p>
                    strat_vol &lt;- strat_ret %&gt;% 
    mutate(portvol = rollapply(Return, width = 60, FUN= sd, fill = NA, align = "right")) %&gt;%
    mutate(fweight = 0.02/portvol) %&gt;% select(Date, fweight)
port_wt &lt;- stratwts %&gt;% left_join(strat_vol, by = "Date") %&gt;%
mutate(weight = weight * fweight) 
port_cost &lt;- calculate_cost(port_wt)
port_returns &lt;- gen_returns(port_cost)
gen_stats(port_returns %&gt;% filter(Date &gt; "1980-01-01"))
                </p>
                <p>
                    z &lt;- data.frame(matrix(nrow = 0, ncol = 4))
colnames(z) &lt;- c("date","ticker","sentiment", "news_buzz")
for(i in stocks){
Quandl.api_key('Tu_djozePNhyxDs1ij4C')
a &lt;- Quandl.datatable('IFT/NSA', ticker=i, paginate=TRUE)
a &lt;- a %&gt;% 
select("date","ticker", "sentiment", "news_buzz")
z &lt;- rbind(z,a)
                </p>
                <p>
                    }
colnames(z) &lt;- c("Date", "Stock","sentiment", "news_buzz")
z &lt;- z %&gt;% group_by(Stock) %&gt;% arrange(Stock, Date)
snp_news &lt;- snp_tidy %&gt;% left_join(z, by= c("Date","Stock"))
snp_news &lt;- snp_news %&gt;% group_by(Stock) %&gt;%
mutate(vol =  rollapply(returns, width = 250, FUN= sd, fill = NA, align = "right"))
snp_news &lt;- snp_news %&gt;% filter(Date &gt; "2013-01-01")
                </p>
                <p>
                    gen_sentiment_wts &lt;- function(data){
    data &lt;- data %&gt;% filter(exist == 1) %&gt;%
    group_by(Date) %&gt;%
    mutate(rank = rank(sentiment, na.last = "keep")) %&gt;%
    mutate(weight = ifelse(rank &lt;= 0.2*sum(exist, na.rm = T), -1, ifelse(rank &gt;= 0.8*sum(exist, na.rm = T), 1, 0))) %&gt;%
    mutate(weight = weight/vol) %&gt;%
    mutate(weight = weight/sum(abs(weight), na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight, 3)) %&gt;%
    mutate(weight = rollapply(weight, width = 20, FUN= mean, fill = NA, align = "right"))%&gt;%
    ungroup()
                </p>
                <p>
                    }
                </p>
                <p>
                    sentiment_wts &lt;- gen_sentiment_wts(snp_news)
sentiment_cost &lt;- calculate_cost(sentiment_wts)
sentiment_returns &lt;- gen_returns(sentiment_cost)
gen_stats(sentiment_returns)
                </p>
                <p>
                    gen_buzz_wts &lt;- function(data){
    data &lt;- data %&gt;% filter(exist == 1) %&gt;%
    group_by(Date) %&gt;%
    mutate(rank = rank(news_buzz, na.last = "keep")) %&gt;%
    mutate(weight = ifelse(rank &lt;= 0.2*sum(exist, na.rm = T), -1, ifelse(rank &gt;= 0.8*sum(exist, na.rm = T), 1, 0))) %&gt;%
    mutate(weight = weight/vol) %&gt;%
    mutate(weight = weight/sum(abs(weight), na.rm = T)) %&gt;%
    ungroup() %&gt;% group_by(Stock) %&gt;%
    mutate(weight = shift(weight, 3)) %&gt;%
    mutate(weight = rollapply(weight, width = 20, FUN= mean, fill = NA, align = "right"))%&gt;%
    ungroup()
                </p>
                <p>
                    }
                </p>
                <p>
                    buzz_wts &lt;- gen_buzz_wts(snp_news)
buzz_cost &lt;- calculate_cost(buzz_wts)
buzz_returns &lt;- gen_returns(buzz_cost)
gen_stats(buzz_returns)
                </p>
            </div>
            <div class="" id="built-with">
                <h2>
                    Built With
                </h2>
                <ul class="no-bullet inline-list">
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/r">
                                r
                            </a>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </body>
</html>
