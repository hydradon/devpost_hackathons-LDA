<html>
    <head>
    </head>
    <body>
        <div class="large-9 columns" id="app-details-left">
            <div id="gallery">
                <ul>
                    <li>
                        <div class="flex-video">
                            <iframe allowfullscreen="allowfullscreen" allowscriptaccess="always" class="video-embed" frameborder="0" height="371" mode="transparent" src="https://www.youtube.com/embed/ATf79a6v5XU?enablejsapi=1&amp;hl=en_US&amp;rel=0&amp;start=&amp;version=3&amp;wmode=transparent" type="text/html" webkitallowfullscreen="true" width="660" wmode="transparent">
                            </iframe>
                        </div>
                    </li>
                    <li class="text-center">
                        <a data-lightbox="873728" data-title="logo" href="https://challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/873/728/datas/original.png">
                            <img alt="rhv2prometheus &ndash; screenshot 1" class="software_photo_image image-replacement" onerror="this.onerror=null;this.src='https://devpost-challengepost.netdna-ssl.com/assets/defaults/thumbnail-placeholder-42bcab8d8178b413922ae2877d8b0868.gif';" src="//challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/873/728/datas/gallery.jpg">
                        </a>
                        <span class="expand-tag">
                            <i class="fas fa-expand">
                            </i>
                        </span>
                        <p>
                            <i>
                                logo
                            </i>
                        </p>
                    </li>
                </ul>
            </div>
            <div>
                <h2>
                    Inspiration
                </h2>
                <p>
                    As solutions architects working for our company, Sopra Steria, we got involved in a project deploying and administrating a Openshift Container Platform Cluster over Red Hat Hyperconverged Infrastructure. Regarding monitoring, the client expressed their need to unify this platform  with their corporate monitoring solution.
                </p>
                <p>
                    Our starting point was a Grafana console with Prometheus as a data source for Openshift metrics. To check infrastructure metrics we had to access Red Hat Virtualization Manager console, which does not allow us to create monitoring dashboards or to have a proactive monitoring.
                </p>
                <p>
                    Additionally  the client had their corporate monitoring suite based on Nagios. So they saw the need to integrate this new OCP+RHHI infrastructure to their Nagios environment by adding the metrics captured from their OCP&rsquo;s Prometheus and RHV consoles.
                </p>
                <p>
                    I  consider myself a sysadmin, not a developer,  but have always been very passionate trying to solve all challenges that I encounter. I have often used Nodejs and their massive package catalog to achieve my goals. Once again, it seemed to be the right choice to solve this scenario.
                </p>
                <h2>
                    What it does
                </h2>
                <p>
                    This project written in Nodejs aims to cover a gap detected in RedHat Openshift (3.11, 4.X) solutions deployed on RHHI with RHV, and it is the impossibility of centralizing infrastructure monitoring on a single console.
                </p>
                <p>
                    With RHV2Prometheus, metrics are generated based on the objects discovered in the RHV api and imported  to OCP&rsquo;s Prometheus. Once imported you can create dashboards on OCP&rsquo;s Grafana and can be queried from Nagios official plugin, also can integrate third party solutions with API REST and other possiblilities.
                </p>
                <p>
                    It presents a secured SSO interface to query imported events generated on RHV console. You can also view metrics to be scraped from OCP&rsquo;s Prometheus, edit metric thresholds, customize Nagios configuration templates or test an API query.
                </p>
                <p>
                    It also includes a functionality to simulate the response of a ovirt api (static values from a lab or your own). This is ideal to test if you don&rsquo;t have an API to query. We had to use it in the Hackathon because there was not a RHV resource available to use for demonstration purposes.
                </p>
                <ul>
                    <li>
                        <a href="https://www.redhat.com/en/technologies/storage/hyperconverged-infrastructure" rel="nofollow">
                            Red Hat Hyperconverged infrastructure
                        </a>
                    </li>
                    <li>
                        <a href="https://www.redhat.com/en/technologies/virtualization/enterprise-virtualization" rel="nofollow">
                            RedHat Virtualization
                        </a>
                    </li>
                    <li>
                        <a href="https://www.redhat.com/en/technologies/cloud-computing/openshift" rel="nofollow">
                            Openshift
                        </a>
                    </li>
                    <li>
                        <a href="https://access.redhat.com/products/red-hat-single-sign-on" rel="nofollow">
                            Red Hat Single Sign-On
                        </a>
                    </li>
                    <li>
                        <a href="https://www.redhat.com/es/technologies/jboss-middleware/3scale" rel="nofollow">
                            Red Hat 3scale
                        </a>
                    </li>
                </ul>
                <h2>
                    How we built it
                </h2>
                <p>
                    As mentioned before, RHV2Prometheus is built in Nodejs. The first obstacle encountered was to understand how RHV api worked and its structure. On early stages, started to query RH lab environments, which where renewed each week, at a very slow pace. Once it was tested long enough, moved on to the client&rsquo;s OCP cluster running on high availability RHHI infrastructure.
                </p>
                <p>
                    The launch iterations where executed on a pre-defined interval. Each iteration will recreate metrics collected and obtain its value. The process is automated, there is no need to configure each infrastructure change.
                </p>
                <h2>
                    Challenges we ran into
                </h2>
                <p>
                    The first challenge was to identify the metrics who are interesting to import to Prometheus, some API objects have a statistics class, but we expand it building metrics from any numeric value from its description, it was the best chance to leave it autonomous in the metrics creation.
                </p>
                <p>
                    Once the number of queries is increased, it sometimes ended by collapsing RHVM by denying of service (OUCH!). To solve this issue, we implemented an api call queue, setting priorities for each API call to RHV.
This way, you cannot make more than one api call within the same 100ms ratio, the older calls get a higher priority than the most recent ones.
                </p>
                <p>
                    To reduce the number of queries sent to RHV, a cache array is created to translate object id to names. This way we reduced the number of queries by 50% and this data is inmutable.
                </p>
                <p>
                    Another challenge was to understand Openshift&rsquo;s Operators, in this case the monitoring operator. Once understood, we edited Prometheus default configMap configuration so we can scrape from our app.
                </p>
                <p>
                    Regarding Nagios configuration,  had the experience and knowledge to automate its configuration, since I had been a Nagios administrator in the past.
                </p>
                <h2>
                    Accomplishments that we're proud of
                </h2>
                <p>
                    Our best accomplishment was to build a product based on our client&rsquo;s need, which has been my first app under a MIT license, and would be honored if this functionality is included or considered on future Red Hat solutions.
                </p>
                <h2>
                    What we learned
                </h2>
                <p>
                    We have improved my Javascript skills and had the chance to learn about Red Hat products that where new to us (RHV, RHHI, 3Scale,SSO,etc&hellip;), not only to integrate them in this solution, but to include them on future product designs.
We also increased our knowledge on Openshift in different environments (ARO,Openshift dedicated,OCP), as well as Operators and how they interact with the cluster and how/when they can be customized.
And of course, gained expertise on Openshift  and improved the knowledge acquired on the official training program.
                </p>
                <h2>
                    What's next for rhv2prometheus
                </h2>
                <p>
                    We defined our next steps to explore posibilities to build it as operator, without Nagios customization and thresholds. This way it can be deployed on RHHI+OCP infrastructures and try to automate its configuration so the user doesn&rsquo;t need to add configuration parameters.
                </p>
                <h2>
                    Getting started
                </h2>
                <p>
                    Depending on where we want to go, the requirements to test RHV2prometheus vary:
                </p>
                <p>
                    <strong>
                        NODE.js
                    </strong>
                    Allows us to run RHV2Prometheus on our laptop or any node server.
                </p>
                <p>
                    <strong>
                        Openshift Container Platform 3.11/4.X
                    </strong>
                    we can deploy and integrate it with the prometheus out-of-the-box, only tested in Openshift 3.11 with Prometheus-operator.
                </p>
                <p>
                    <strong>
                        Red Hat Virtualization
                    </strong>
                    What we consult is the ovirt api, so it could be integrated with other solutions, only tested in RHV 4.0 of the labs in OPENTLC.com and RHV 4.0 over RHHI.
                </p>
                <h3>
                    Installation
                </h3>
                <p>
                    First you need to clone the repo to local and edit the .env file
                </p>
                <pre class="language-nolang"><code>RHEVserver="https://YOURSERVER"
# User example "admin@internal"
# Password example "r3dh4t1!"
# Base64 encoded user@domain:password
RHVCredentials="YWRtaW5AaW50ZXJuYWw6cjNkaDR0MSE="
RHSSO="true"
RHSSOcert=""
</code></pre>
                <p>
                    then select your option [
                    <strong>
                        Openshift
                    </strong>
                    |
                    <strong>
                        Node.js
                    </strong>
                    ]
                </p>
                <ul>
                    <li>
                        <strong>
                            Openshift
                        </strong>
                    </li>
                </ul>
                <p>
                    Here are some steps to take it working, obiously you can take your own way.
                </p>
                <pre class="language-nolang"><code># create the project
oc new-project rhv2prometheus --description="Create prometheus metrics from RHV" --display-name="rhv2prometheus"
# create build from source
oc new-build --name rhv2prometheus --strategy=source --binary --image-stream=nodejs:latest
# start the build
oc start-build rhv2prometheus --from-dir=. --follow
# create the app
oc new-app rhv2prometheus
# expose the service
oc expose svc/rhv2prometheus
</code></pre>
                <p>
                    Then you can access to
                    <a href="http://rhv2prometheus-rhv2prometheus.yourappdomain.com/metrics" rel="nofollow">
                        http://rhv2prometheus-rhv2prometheus.yourappdomain.com/metrics
                    </a>
                    to check the metrics to scrape from another prometheus.
                </p>
                <p>
                    Also can check the events in:
                    <a href="http://rhv2prometheus-rhv2prometheus.yourappdomain.com/events" rel="nofollow">
                        http://rhv2prometheus-rhv2prometheus.yourappdomain.com/events
                    </a>
                </p>
                <p>
                    For config the prometheus-operator out-of-the-box, here we use some steps that can be optimized, but the next works for us:
                </p>
                <p>
                    *Cluster admin rights are required
                </p>
                <ol>
                    <li>
                        Clone the configmap
                        <a href="https://github.com/openshift/cluster-monitoring-operator/blob/master/Documentation/user-guides/configuring-cluster-monitoring.md" rel="nofollow">
                            cluster-monitoring-config
                        </a>
                        to a new one
                        <strong>
                            prometheus-custom-cfg
                        </strong>
                        in the project "openshift-monitoring" adding our RHV2prometheus svc route to the scape_configs:
                        <code>
                            - job_name: custom/rhv-monitoring
static_configs:
- targets: ['rhv2prometheus-rhv2prometheus.yourappdomain.com']
                        </code>
                    </li>
                    <li>
                        The Stateful Set
                        <em>
                            "prometheus-k8s"
                        </em>
                        have defined 4 containers (prometheus, prometheus-config-reloader, prometheus-proxy, rules-configmap-reloader) inside each prometheus pods, we just need to edit the prometheus-config-reloader:
                    </li>
                </ol>
                <p>
                    Mount the new configmap adding our config_custom mountPath:
                </p>
                <p>
                    <em>
                        in the app definition:
                    </em>
                </p>
                <pre class="language-nolang"><code>      volumes:
                                - configMap:
                                defaultMode: 420
                                name: prometheus-custom-cfg
                                name: prometheus-custom-cfg
</code></pre>
                <p>
                    <em>
                        in the container definition:
                    </em>
                </p>
                <pre class="language-nolang"><code>          volumeMounts:
                                                - mountPath: /etc/prometheus/config_custom
                                                name: prometheus-custom-cfg
                                                readOnly: true
</code></pre>
                <p>
                    <em>
                        Edit the - args of the container to use our custom cfg with the flag --config-file:
                    </em>
                </p>
                <pre class="language-nolang"><code>'--config-file=/etc/prometheus/config_custom/prometheus.yaml'
</code></pre>
                <p>
                    Saving the Stateful Set will start the new deploy, and prometheus-config-reloader will send the new config to the container prometheus.
                </p>
                <p>
                    Then we can check our new metrics inside prometheus
                </p>
                <ul>
                    <li>
                        <strong>
                            Node.js
                        </strong>
                    </li>
                </ul>
                <p>
                    install it:
                </p>
                <pre class="language-nolang"><code>npm install
</code></pre>
                <p>
                    then take a look at the package.json, scripts definition:
                </p>
                <pre class="language-nolang"><code>    "start": "set RHEVtest=false&amp;&amp; set RHEVrecord=false&amp;&amp; node server.js",
                "start-no-sso": "set RHEVtest=false&amp;&amp; set RHEVrecord=false&amp;&amp; node server.js",
    "test": "node simulator.js&amp;&amp; set RHEVtest=true&amp;&amp; set RHEVrecord=false&amp;&amp; node server.js",
    "record": "set RHEVtest=false&amp;&amp; set RHEVrecord=true&amp;&amp; node server.js"
</code></pre>
                <p>
                    to start it connecting to the .env.RHVServer and use SSO:
                </p>
                <pre class="language-nolang"><code>npm start
</code></pre>
                <p>
                    if you want to record the api output for simulator run:
                </p>
                <pre class="language-nolang"><code>npm run record
</code></pre>
                <p>
                    if you want to test connecting to the api simulator, run:
                </p>
                <pre class="language-nolang"><code>npm run test
</code></pre>
                <p>
                    Then you can access to
                    <a href="http://localhost:8080/metrics" rel="nofollow">
                        http://localhost:8080/metrics
                    </a>
                    to check the metrics to scrape from another prometheus.
                </p>
                <p>
                    Also can check the events in:
                    <a href="http://localhost:8080/events" rel="nofollow">
                        http://localhost:8080/events
                    </a>
                </p>
            </div>
            <div class="" id="built-with">
                <h2>
                    Built With
                </h2>
                <ul class="no-bullet inline-list">
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/javascript">
                                javascript
                            </a>
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/node-js">
                                node.js
                            </a>
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/openshift">
                                openshift
                            </a>
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            ovirt
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            prometheus
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            rhhi
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            rhv
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            virtualization
                        </span>
                    </li>
                </ul>
            </div>
            <nav class="app-links section">
                <h2>
                    Try it out
                </h2>
                <ul class="no-bullet" data-role="software-urls">
                    <li>
                        <a href="https://github.com/mparram/rhv2prometheus" rel="nofollow" target="_blank" title="https://github.com/mparram/rhv2prometheus">
                            <i class="ss-icon ss-link">
                            </i>
                            <span>
                                github.com
                            </span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </body>
</html>
