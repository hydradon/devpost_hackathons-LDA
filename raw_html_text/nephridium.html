<html>
    <head>
    </head>
    <body>
        <div class="large-9 columns" id="app-details-left">
            <div id="gallery">
                <ul>
                    <li>
                        <div class="flex-video">
                            <iframe allowfullscreen="allowfullscreen" allowscriptaccess="always" class="video-embed" frameborder="0" height="371" mode="transparent" src="https://www.youtube.com/embed/zwpBvL0dmYw?enablejsapi=1&amp;hl=en_US&amp;rel=0&amp;start=&amp;version=3&amp;wmode=transparent" type="text/html" webkitallowfullscreen="true" width="660" wmode="transparent">
                            </iframe>
                        </div>
                    </li>
                    <li class="text-center">
                        <a data-lightbox="691486" data-title="nephridium in action" href="https://challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/691/486/datas/original.png">
                            <img alt="nephridium &ndash; screenshot 1" class="software_photo_image image-replacement" onerror="this.onerror=null;this.src='https://devpost-challengepost.netdna-ssl.com/assets/defaults/thumbnail-placeholder-42bcab8d8178b413922ae2877d8b0868.gif';" src="//challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/691/486/datas/gallery.jpg">
                        </a>
                        <span class="expand-tag">
                            <i class="fas fa-expand">
                            </i>
                        </span>
                        <p>
                            <i>
                                nephridium in action
                            </i>
                        </p>
                    </li>
                </ul>
            </div>
            <div>
                <h1>
                    nephridium
                </h1>
                <p>
                    An
                    <a href="https://devpost.com/software/nephridium" rel="nofollow">
                        award-winning
                    </a>
                    <a href="https://aws.amazon.com/serverless/" rel="nofollow">
                        AWS Serverless Appliction
                    </a>
                    that produces filtered Socrata datasets.
                    <em>
                        NOT
                    </em>
                    affiliated with or endorsed by
                    <a href="https://socrata.com/company-info/" rel="nofollow">
                        Socrata
                    </a>
                    .
                </p>
                <h2>
                    Why?
                </h2>
                <p>
                    Hundreds of local, state and federal government organizations use
                    <a href="https://socrata.com/company-info/" rel="nofollow">
                        Socrata
                    </a>
                    to host open data portals to share data sets with the public. The public can interact with these datasets in various ways, but these ways may not be intuitive for the general public. And people who understand how to manipulate these datasets don't want to repeat the same manual tasks every day, week or month.
                </p>
                <p>
                    <em>
                        nephridium
                    </em>
                    addresses the use case where a dynamically filtered Socrata dataset is desired over time. You specify the Socrata dataset, tell
                    <em>
                        nephridium
                    </em>
                    what the date attribute is and you get an HTML table of the data!
                    <em>
                        nephridium
                    </em>
                    offers additional parameters you can use to choose which attributes you want to display and to further filter your dataset.
                </p>
                <h3>
                    A use case
                </h3>
                <h4>
                    A repetative task
                </h4>
                <p>
                    A
                    <a href="https://www.stpaul.gov/residents/live-saint-paul/neighborhoods/district-councils" rel="nofollow">
                        Saint Paul District Council
                    </a>
                    Executive Director wants to know all of the resident service requests that created in her district the past week. And she wants this information every week.
                </p>
                <p>
                    Saint Paul provides
                    <a href="https://information.stpaul.gov/City-Infrastructure/Resident-Service-Requests-Dataset/3w6i-nfpw" rel="nofollow">
                        the data
                    </a>
                    , but only in a way where the Executive Director has to enter filter information every single time she visits the site.
                </p>
                <h4>
                    A one-click solution...
                </h4>
                <p>
                    Since
                    <em>
                        nephridium
                    </em>
                    uses a look-back date filter, one URL will work in perpetuity. For example,
                    <code>
                        https://your_aws_url/?district_council=8&amp;time_column=request_date&amp;url=https://information.stpaul.gov/resource/qtkm-psvs
                    </code>
                    will produce the previous 7 days' results for service requests in District 8.
                </p>
                <h4>
                    ...that can become a no-click solution
                </h4>
                <p>
                    Once an URL is created it can be used with
                    <a href="https://ifttt.com" rel="nofollow">
                        IFTTT
                    </a>
                    ,
                    <a href="https://zapier.com/" rel="nofollow">
                        Zapier
                    </a>
                    ,
                    <a href="https://en.wikipedia.org/wiki/Cron" rel="nofollow">
                        cron
                    </a>
                    or any other automation tool to automatically send an email with the requested data.
                </p>
                <h2>
                    The name
                </h2>
                <p>
                    <a href="https://en.wikipedia.org/wiki/Nephridium" rel="nofollow">
                        Nephridium
                    </a>
                    is like a kidney for an invertabrate. It filters things, just like this code.
                </p>
                <h2>
                    Build an URL for
                    <em>
                        nephridium
                    </em>
                </h2>
                <p>
                    You will need
                </p>
                <ul>
                    <li>
                        <em>
                            NEPHRIDIUM_URL:
                        </em>
                        A deployed version of
                        <em>
                            nephridium
                        </em>
                        (see the section
                        <code>
                            Host your own instance of nephridium
                        </code>
                        below)
                    </li>
                    <li>
                        <em>
                            DATASET_URL:
                        </em>
                        A
                        <a href="https://socrata.com/company-info/" rel="nofollow">
                            Socrata
                        </a>
                        dataset. See
                        <a href="https://www.opendatanetwork.com/search?q=service+requests" rel="nofollow">
                            https://www.opendatanetwork.com/search?q=service+requests
                        </a>
                        if you need one to try out. You can also search for you city/state/county, like
                        <a href="https://www.opendatanetwork.com/search?q=kalamazoo" rel="nofollow">
                            https://www.opendatanetwork.com/search?q=kalamazoo
                        </a>
                        . Note that the dataset URL is specific --
                        <a href="https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5" rel="nofollow">
                            https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5
                        </a>
                        is an example. The page should have the text
                        <code>
                            About this dataset
                        </code>
                        on it and maybe some example URLs.
                    </li>
                    <li>
                        <em>
                            TIME_COLUMN:
                        </em>
                        A
                        <code>
                            floating_timestamp
                        </code>
                        value for your dataset. This is the value that's used to get the last week or month of entries. If you scroll down on the dataset page to the
                        <code>
                            Fields
                        </code>
                        section there should be at least one
                        <code>
                            floating_timestamp
                        </code>
                        . On
                        <a href="https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5" rel="nofollow">
                            https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5
                        </a>
                        <code>
                            deadline_date
                        </code>
                        is the value.
                    </li>
                </ul>
                <p>
                    Whew! Now that you have the ingredients it's time to craft the URL you'll be using.
                </p>
                <p>
                    For an example we'll use
                </p>
                <ul>
                    <li>
                        <em>
                            NEPHRIDIUM_URL:
                        </em>
                        <code>
                            https://abcd1234.execute-api.us-east-1.amazonaws.com/Prod/
                        </code>
                    </li>
                    <li>
                        <em>
                            DATASET_URL:
                        </em>
                        <code>
                            https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5
                        </code>
                    </li>
                    <li>
                        <em>
                            TIME_COLUMN:
                        </em>
                        <code>
                            deadline_date
                        </code>
                    </li>
                </ul>
                <p>
                    to build our minimal URL (must include a
                    <code>
                        time_column
                    </code>
                    and a
                    <code>
                        url
                    </code>
                    )
                </p>
                <p>
                    <code>
                        https://abcd1234.execute-api.us-east-1.amazonaws.com/Prod/?time_column=deadline_date&amp;url=https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5
                    </code>
                </p>
                <p>
                    Make sure DATASET_URL is last!
                </p>
                <p>
                    If we want to further filter the dataset we can do that, too.
                </p>
                <h3>
                    Excluding columns
                </h3>
                <p>
                    In our example, let's say we don't want to see the county column. We'll add a
                    <code>
                        to_remove
                    </code>
                    parameter for that.
                </p>
                <p>
                    <code>
                        https://abcd1234.execute-api.us-east-1.amazonaws.com/Prod/?time_column=deadline_date&amp;to_remove=county&amp;url=https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5
                    </code>
                </p>
                <p>
                    And if we want to remove more than one column, we just separate them with a comma (no spaces!). Let's also remove the column that shows whether there's a GPA requirement.
                </p>
                <p>
                    <code>
                        https://abcd1234.execute-api.us-east-1.amazonaws.com/Prod/?time_column=deadline_date&amp;to_remove=county,gpa_req_y_n&amp;url=https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5
                    </code>
                </p>
                <h3>
                    Filtering data
                </h3>
                <p>
                    Let's retrieve only records where you don't have to have graduated to be eligible. We do this by specifying the column name (
                    <code>
                        grad_y_n
                    </code>
                    ) and a value in the URL.
                </p>
                <p>
                    <code>
                        https://abcd1234.execute-api.us-east-1.amazonaws.com/Prod/?time_column=deadline_date&amp;grad_y_n=N&amp;url=https://dev.socrata.com/foundry/data.michigan.gov/kkup-j7i5
                    </code>
                </p>
                <h3>
                    More!
                </h3>
                <p>
                    See the Socrata API documentation for more options, especially
                </p>
                <ul>
                    <li>
                        <a href="https://dev.socrata.com/docs/filtering.html" rel="nofollow">
                            https://dev.socrata.com/docs/filtering.html
                        </a>
                    </li>
                    <li>
                        <a href="https://dev.socrata.com/docs/queries/" rel="nofollow">
                            https://dev.socrata.com/docs/queries/
                        </a>
                    </li>
                </ul>
                <h2>
                    Host your own instance of
                    <em>
                        nephridium
                    </em>
                </h2>
                <h3>
                    Requirements
                </h3>
                <ul>
                    <li>
                        AWS CLI already configured with at least PowerUser permission
                    </li>
                    <li>
                        <a href="https://nodejs.org/en/download/" rel="nofollow">
                            NodeJS 8.10+ installed
                        </a>
                    </li>
                    <li>
                        <a href="https://www.docker.com/community-edition" rel="nofollow">
                            Docker installed
                        </a>
                    </li>
                </ul>
                <h3>
                    Setup process
                </h3>
                <h4>
                    Installing dependencies
                </h4>
                <p>
                    In this example we use
                    <code>
                        npm
                    </code>
                    but you can use
                    <code>
                        yarn
                    </code>
                    if you prefer to manage NodeJS dependencies:
                </p>
                <pre class="language-bash"><code>cd nephridium
npm install
cd ../
</code></pre>
                <h4>
                    Local development
                </h4>
                <p>
                    You can modify
                    <em>
                        nephridium
                    </em>
                    to return JSON instead of HTML, internallly filter your dataset(s) to minimize the number of parameters in your users' URLs, format the output (e.g., custom CSS), or restrict who can access the API.
                </p>
                <p>
                    <strong>
                        Invoking function locally through local API Gateway
                    </strong>
                </p>
                <pre class="language-bash"><code>sam local start-api
</code></pre>
                <p>
                    If the previous command ran successfully you should now be able to hit the following local endpoint to invoke your function. Note that CloudFront (but not your local api) returns a 403 when it receives a GET with a body, so you must use query parameters instead.
                </p>
                <p>
                    <strong>
                        SAM CLI
                    </strong>
                    is used to emulate both Lambda and API Gateway locally and uses our
                    <code>
                        template.yaml
                    </code>
                    .
                </p>
                <h3>
                    Packaging and deployment
                </h3>
                <p>
                    AWS Lambda NodeJS runtime requires a flat folder with all dependencies including the application. SAM will use
                    <code>
                        CodeUri
                    </code>
                    property to know where to look up for both application and dependencies:
                </p>
                <pre class="language-yaml"><code>...
                ReportFunction:
                Type: AWS::Serverless::Function
                Properties:
                CodeUri: nephridium/
                ...
</code></pre>
                <p>
                    Firstly, we need a
                    <code>
                        S3 bucket
                    </code>
                    where we can upload our Lambda functions packaged as ZIP before we deploy anything - If you don't have a S3 bucket to store code artifacts then this is a good time to create one:
                </p>
                <pre class="language-bash"><code>aws s3 mb s3://BUCKET_NAME
</code></pre>
                <p>
                    Next, run the following command to package our Lambda function to S3:
                </p>
                <pre class="language-bash"><code>sam package \
                --template-file template.yaml \
    --output-template-file packaged.yaml \
    --s3-bucket BUCKET_NAME
</code></pre>
                <p>
                    Next, the following command will create a Cloudformation Stack and deploy your SAM resources. I've only been able to do this using an IAM user with full administrator rights.
                </p>
                <pre class="language-bash"><code>sam deploy \
                --template-file packaged.yaml \
    --stack-name BUCKET_NAME \
    --capabilities CAPABILITY_IAM
</code></pre>
                <p>
                    Return from package call recommends the following, so you could try it as well:
                </p>
                <pre class="language-bash"><code>aws cloudformation deploy --template-file /private/tmp/sam/nephridium/packaged.yaml --stack-name BUCKET_NAME
</code></pre>
                <blockquote>
                    <p>
                        <strong>
                            See
                            <a href="https://github.com/awslabs/serverless-application-model/blob/master/HOWTO.md" rel="nofollow">
                                Serverless Application Model (SAM) HOWTO Guide
                            </a>
                            for more details in how to get started.
                        </strong>
                    </p>
                </blockquote>
                <p>
                    After deployment is complete you can run the following command to retrieve the API Gateway Endpoint URL:
                </p>
                <pre class="language-bash"><code>aws cloudformation describe-stacks \
                --stack-name BUCKET_NAME \
    --query 'Stacks[].Outputs'
</code></pre>
                <h3>
                    Unit testing
                </h3>
                <p>
                    We use
                    <code>
                        mocha
                    </code>
                    for testing our code and it is already added in
                    <code>
                        package.json
                    </code>
                    under
                    <code>
                        scripts
                    </code>
                    , so that we can simply run the following command to run our tests:
                </p>
                <pre class="language-bash"><code>cd nephridium
npm run test
</code></pre>
                <h1>
                    Appendix
                </h1>
                <h2>
                    AWS CLI commands
                </h2>
                <p>
                    AWS CLI commands to package, deploy and describe outputs defined within the cloudformation stack:
                </p>
                <pre class="language-bash"><code>sam package \
                --template-file template.yaml \
    --output-template-file packaged.yaml \
    --s3-bucket BUCKET_NAME

sam deploy \
--template-file packaged.yaml \
--stack-name BUCKET_NAME \
--capabilities CAPABILITY_IAM

aws cloudformation describe-stacks \
--stack-name BUCKET_NAME --query 'Stacks[].Outputs'
</code></pre>
                <p>
                    <strong>
                        NOTE
                    </strong>
                    : Alternatively this could be part of package.json scripts section.
                </p>
                <h2>
                    Bringing to the next level
                </h2>
                <h2>
                    API testing
                </h2>
                <p>
                    Providing test examples for local and deployed endpoints
                </p>
                <h3>
                    Bare minimum --
                    <code>
                        time_column
                    </code>
                    and
                    <code>
                        url
                    </code>
                </h3>
                <pre class="language-bash"><code>curl -vvv 'http://127.0.0.1:3000/?time_column=request_date&amp;url=https://information.stpaul.gov/resource/qtkm-psvs'

curl -vvv 'https://abcd1234.execute-api.us-east-1.amazonaws.com/Prod/?time_column=request_date&amp;url=https://information.stpaul.gov/resource/qtkm-psvs'
</code></pre>
                <h3>
                    Custom parameters in query
                </h3>
                <pre class="language-bash"><code>curl -vvv 'http://127.0.0.1:3000/?district_council=8&amp;time_column=request_date&amp;url=https://information.stpaul.gov/resource/qtkm-psvs'

curl -vvv 'https://abcd1234.execute-api.us-east-1.amazonaws.com/Prod/?district_council=8&amp;time_column=request_date&amp;url=https://information.stpaul.gov/resource/qtkm-psvs'
</code></pre>
                <h3>
                    Custom parameters in query with filtered attributes
                </h3>
                <pre class="language-bash"><code>curl -vvv -X GET 'http://127.0.0.1:3000/?district_council=8&amp;time_column=request_date&amp;to_remove=count,map_location&amp;url=https://information.stpaul.gov/resource/qtkm-psvs'


</code></pre>
            </div>
            <div class="" id="built-with">
                <h2>
                    Built With
                </h2>
                <ul class="no-bullet inline-list">
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/javascript">
                                javascript
                            </a>
                        </span>
                    </li>
                </ul>
            </div>
            <nav class="app-links section">
                <h2>
                    Try it out
                </h2>
                <ul class="no-bullet" data-role="software-urls">
                    <li>
                        <a href="https://github.com/eebbesen/nephridium" rel="nofollow" target="_blank" title="https://github.com/eebbesen/nephridium">
                            <i class="ss-icon ss-link">
                            </i>
                            <span>
                                github.com
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="https://jukghiey6f.execute-api.us-east-1.amazonaws.com/Prod/?district_council=8&amp;time_column=request_date&amp;to_remove=count,map_location,see_click_fix_website_submission&amp;url=https://information.stpaul.gov/resource/qtkm-psvs" rel="nofollow" target="_blank" title="https://jukghiey6f.execute-api.us-east-1.amazonaws.com/Prod/?district_council=8&amp;time_column=request_date&amp;to_remove=count,map_location,see_click_fix_website_submission&amp;url=https://information.stpaul.gov/resource/qtkm-psvs">
                            <i class="ss-icon ss-link">
                            </i>
                            <span>
                                jukghiey6f.execute-api.us-east-1.amazonaws.com
                            </span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </body>
</html>
