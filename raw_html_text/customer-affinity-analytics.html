<html>
    <head>
    </head>
    <body>
        <div class="large-9 columns" id="app-details-left">
            <div id="gallery">
                <ul>
                    <li>
                        <div class="flex-video">
                            <iframe allowfullscreen="allowfullscreen" allowscriptaccess="always" class="video-embed" frameborder="0" height="371" mode="transparent" src="https://www.youtube.com/embed/o3HG-b-C4vM?enablejsapi=1&amp;hl=en_US&amp;rel=0&amp;start=&amp;version=3&amp;wmode=transparent" type="text/html" webkitallowfullscreen="true" width="660" wmode="transparent">
                            </iframe>
                        </div>
                    </li>
                    <li class="text-center">
                        <a data-lightbox="400125" data-title="Top 10 Association Rules by Lift" href="https://challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/400/125/datas/original.png">
                            <img alt="Customer Affinity Analytics Pathway &ndash; screenshot 1" class="software_photo_image image-replacement" onerror="this.onerror=null;this.src='https://devpost-challengepost.netdna-ssl.com/assets/defaults/thumbnail-placeholder-42bcab8d8178b413922ae2877d8b0868.gif';" src="//challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/400/125/datas/gallery.jpg">
                        </a>
                        <span class="expand-tag">
                            <i class="fas fa-expand">
                            </i>
                        </span>
                        <p>
                            <i>
                                Top 10 Association Rules by Lift
                            </i>
                        </p>
                    </li>
                    <li class="text-center">
                        <a data-lightbox="400126" data-title="Network Visualization of Top 10 Association Rules by Lift" href="https://challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/400/126/datas/original.png">
                            <img alt="Customer Affinity Analytics Pathway &ndash; screenshot 2" class="software_photo_image image-replacement" onerror="this.onerror=null;this.src='https://devpost-challengepost.netdna-ssl.com/assets/defaults/thumbnail-placeholder-42bcab8d8178b413922ae2877d8b0868.gif';" src="//challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/400/126/datas/gallery.jpg">
                        </a>
                        <span class="expand-tag">
                            <i class="fas fa-expand">
                            </i>
                        </span>
                        <p>
                            <i>
                                Network Visualization of Top 10 Association Rules by Lift
                            </i>
                        </p>
                    </li>
                    <li class="text-center">
                        <a data-lightbox="400127" data-title="Recommend Algorithm Evaluation" href="https://challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/400/127/datas/original.png">
                            <img alt="Customer Affinity Analytics Pathway &ndash; screenshot 3" class="software_photo_image image-replacement" onerror="this.onerror=null;this.src='https://devpost-challengepost.netdna-ssl.com/assets/defaults/thumbnail-placeholder-42bcab8d8178b413922ae2877d8b0868.gif';" src="//challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/400/127/datas/gallery.jpg">
                        </a>
                        <span class="expand-tag">
                            <i class="fas fa-expand">
                            </i>
                        </span>
                        <p>
                            <i>
                                Recommend Algorithm Evaluation
                            </i>
                        </p>
                    </li>
                </ul>
            </div>
            <div>
                <h2>
                    Introduction
                </h2>
                <p>
                    This Apache Spark application is directed around customer analytics to address marketing execution, gain insights regarding product assortment, and improve the customer experience.
                </p>
                <p>
                    The application provides three features
                </p>
                <ol>
                    <li>
                        Customer Segmentation using a Recency, Frequency, Monetary (RFM) model
                    </li>
                    <li>
                        Market Basket Analysis using Association Rules
                    </li>
                    <li>
                        Evaluation of Product Recommendation Algorithms
                    </li>
                </ol>
                <h2>
                    Specific Business Need
                </h2>
                <p>
                    As customer affinity programs move from plastic barcode cards to mobile apps, companies gain increased opportunities to understand their customers through app engagement data.  This will enhance traditional transaction data because it can include customer preferences, engagements, location, and social activity.  Companies which excel at this new data augmentation have the potential to offer better customer experiences.
                </p>
                <p>
                    <img alt="Mobile Pay" data-canonical-url="https://drive.google.com/uc?export=view&amp;id=0B_LVBjTSvf5rRVVaM3phbk9ZRUE&amp;authuser=0" src="https://res.cloudinary.com/devpost/image/fetch/s--PpvN1GGq--/c_limit,f_auto,fl_lossy,q_auto:eco,w_900/https://drive.google.com/uc%3Fexport%3Dview%26id%3D0B_LVBjTSvf5rRVVaM3phbk9ZRUE%26authuser%3D0">
                </p>
                <blockquote>
                    <h3>
                        This application is intended to lay the analytics foundation for mobile app affinity programs.   Apache Spark is an analytics operating system to hold all this new data and build applications on top of it for analysis and reporting.
                    </h3>
                </blockquote>
                <h2>
                    About the data
                </h2>
                <p>
                    You want to have a sufficiently large scale data set to explore the capabilities of Apache Spark.   The data set I used for this challenge contained
                    <strong>
                        350 million annonomized customer transaction records.
                    </strong>
                    The data storage for this file was close to
                    <strong>
                        20 GB
                    </strong>
                    .
                </p>
                <h2>
                    Infrastructure and Tools
                </h2>
                <p>
                    The application was developed on the
                    <strong>
                        IBM Bluemix
                    </strong>
                    cloud platform.   It uses the Apache Spark and Object Storage services.   The Apache Spark application runs in the
                    <strong>
                        SparkR
                    </strong>
                    notebook.
                </p>
                <p>
                    I installed the R package,
                    <em>
                        arules,
                    </em>
                    within my SparkR notebook to run the market basket analysis association rules.   Association rules is computationally intensive, and the size of the item sets can grow quite large rather quickly as you data mine for additional sets.
                </p>
                <p>
                    The
                    <em>
                        recommenderlab
                    </em>
                    package was used to evaluate the various product recommendation engines.   Other R packages include
                    <em>
                        arulesViz
                    </em>
                    ,
                    <em>
                        highcharter
                    </em>
                    ,
                    <em>
                        dplyr
                    </em>
                    ,
                    <em>
                        lubridate
                    </em>
                    and
                    <em>
                        magrittr
                    </em>
                    .  In addition, I used the Swift CLI tool to upload the data Object Store.
                </p>
                <h2>
                    Data Transformation
                </h2>
                <p>
                    The initial data set is an aggregate transaction record from multiple retail chains.   In order to perform the proposed analysis in a way that would make sense, I would need to select one chain.   The data set was accompanied with a smaller promotions data set.   I used the promotions data set to identify the chain to select.   I ran a frequency distribution on customer ID to identify the chain with the largest number of customers.   I used this chain as the primary analysis data set.   The one chain subset contains 12 million transaction records.
                </p>
                <h2>
                    Customer Segmentation
                </h2>
                <p>
                    Recency, Frequency, Monetary (RFM) is a simple model to segment existing customers based on a few data points within your transaction data.
                </p>
                <p>
                    <strong>
                        Recency
                    </strong>
                    - When was the customer's last purchase?
                </p>
                <p>
                    <strong>
                        Frequency
                    </strong>
                    - How often does the customer make purchases?
                </p>
                <p>
                    <strong>
                        Monetary
                    </strong>
                    - How much has the customer purchased within at time period?
                </p>
                <p>
                    Each term is scored into five segments.   The terms are grouped and then ordered with 555 being the highly valued customers and 111 being the least.
                </p>
                <p>
                    RFM has two key advantages in a corporate environment.
                </p>
                <ol>
                    <li>
                        Easy to communicate to a broad audience.  Marketing, operations, executive decision makers can understand the principles behind the model.
                    </li>
                    <li>
                        Performs well with transaction data.   If your core customers are trend obsessed, it can track fast moving segment shifts.
                    </li>
                </ol>
                <p>
                    <strong>
                        Process
                    </strong>
                </p>
                <p>
                    The primary objective for this RFM analysis is to compare customer segment differences between last quarter and the most recent quarter.   I created a data frame for each of the RFM elements - recency, frequency, monetary and at each quarter.   There are six data frames in total.   The data frames were exported to partition csv files in Object Store which were used to create the RFM segments and the interactive visualizations in R Studio.  The visualizations used the  highcharter package, a R wrapper for d3 visualizations.
                </p>
                <h3>
                    RFM Heat Map Visualizations
                </h3>
                <p>
                    <img alt="rfm heat map" data-canonical-url="https://drive.google.com/uc?export=view&amp;id=0B_LVBjTSvf5rY0NQUkcwN2VPbkE&amp;authuser=0" src="https://res.cloudinary.com/devpost/image/fetch/s--7RLed8Li--/c_limit,f_auto,fl_lossy,q_auto:eco,w_900/https://drive.google.com/uc%3Fexport%3Dview%26id%3D0B_LVBjTSvf5rY0NQUkcwN2VPbkE%26authuser%3D0">
                </p>
                <p>
                    <img alt="rfm heat map" data-canonical-url="https://drive.google.com/uc?export=view&amp;id=0B_LVBjTSvf5rcE03ck1vRmZNN1U&amp;authuser=0" src="https://res.cloudinary.com/devpost/image/fetch/s--rzJ9V-B1--/c_limit,f_auto,fl_lossy,q_auto:eco,w_900/https://drive.google.com/uc%3Fexport%3Dview%26id%3D0B_LVBjTSvf5rcE03ck1vRmZNN1U%26authuser%3D0">
                </p>
                <p>
                    The heat maps show the quarter to quarter difference.   Last quarter was the Christmas holiday season and it reflects the increased monetary intensity within the top right hand quadrant for the highly valued customers.   The interactive visualization which show the average monetary value for each segment can be found here:
                    <a href="http://rpubs.com/robcamp/affinity" rel="nofollow">
                        http://rpubs.com/robcamp/affinity
                    </a>
                </p>
                <h2>
                    Market Basket Analysis
                </h2>
                <p>
                    Market Basket Analysis attempts to learn about the product relationships in the customer's transactions.  If a customer purchased item A, what can I learn about item B?
                </p>
                <p>
                    Association Rules are written such as
                </p>
                <p>
                    <strong>
                        A ==&gt; B
                    </strong>
                </p>
                <p>
                    Association rules have three important metrics:
                    <strong>
                        Support, Confidence, Lift
                    </strong>
                </p>
                <p>
                    <strong>
                        Support
                    </strong>
                    is the probability both items are in a basket.   It answers the question "What percent of all the customer baskets contain A and B"?
                </p>
                <p>
                    <strong>
                        Confidence
                    </strong>
                    is the conditional probability that B is in the basket given that A is present. It expresses validity for the rule.  Expected confidence is the probability that B is in a basket.
                </p>
                <p>
                    <strong>
                        Lift
                    </strong>
                    is the confidence divided by expected confidence.   It is the ratio of the likelihood of B being in a basket with A to the likelihood of B being in any basket.     When lift is greater than 1, A is believed to
                    <em>
                        lift
                    </em>
                    the presence of B above what we would normally expect to see.
                </p>
                <p>
                    <strong>
                        Data Process
                    </strong>
                </p>
                <p>
                    Using the transaction data frame, I created a unique ID for each transaction.  This ID is transformed to create a customer trip ID which is used to identify all the products purchased on that trip.   The data frame is transformed again to create a customer-product data frame which builds a product history for the customer.   This data frame is used for the market basket analysis.
                </p>
                <p>
                    <strong>
                        Association Rule Learning
                    </strong>
                </p>
                <p>
                    The market basket analysis used the ECLAT (Equivalence Class Transformation) algorithm to build the product item sets.  ECLAT is an elegant algorithm to find frequent item sets.  The analysis seeks to find item set pairs that are in at least 10% of all transactions.   The ECLAT algorithm found 64,487 item set pairs.
                </p>
                <p>
                    The next step is to build the association rules.  I wanted to create a set of rules with 90% confidence.   Simply put, I can say that I am at least 90% confident that Product A has a relationship with Product B.  From the association rules, I created a subset of ten product relationships based on the item sets with the highest lift.   These are used in the following visualizations.
                </p>
                <p>
                    <img alt="rfm heat map" data-canonical-url="https://drive.google.com/uc?export=view&amp;id=0B_LVBjTSvf5rak8tb2k2SDUxSFE&amp;authuser=0" src="https://res.cloudinary.com/devpost/image/fetch/s--K0sCgp8u--/c_limit,f_auto,fl_lossy,q_auto:eco,w_900/https://drive.google.com/uc%3Fexport%3Dview%26id%3D0B_LVBjTSvf5rak8tb2k2SDUxSFE%26authuser%3D0">
                </p>
                <p>
                    This network graph shows the product item sets for the top 10 association rules with the highest lift. This visualization's strength is to show the product relationships.  Product 5620 has five related products.   5621 ==&gt; 5620 has support of .49 which means this item set can be found in 49% of all transactions.
                </p>
                <p>
                    <img alt="Lift Grouped Rules" data-canonical-url="https://drive.google.com/uc?export=view&amp;id=0B_LVBjTSvf5rWHNxNzJyWUk3bXM&amp;authuser=0" src="https://res.cloudinary.com/devpost/image/fetch/s--vQN0w1DO--/c_limit,f_auto,fl_lossy,q_auto:eco,w_900/https://drive.google.com/uc%3Fexport%3Dview%26id%3D0B_LVBjTSvf5rWHNxNzJyWUk3bXM%26authuser%3D0">
                </p>
                <p>
                    This is a 2D representation of the same top 10 association rules with the highest lift.  It represents the lift order, and shows the scale of the support for the item sets.
                </p>
                <h2>
                    Recommendation Engine
                </h2>
                <p>
                    The final step of the analysis is to evaluate product recommendation algorithms.  This is a followup based on the data analysis from the market basket analysis and uses the R objects created from the market basket analysis.
                </p>
                <p>
                    I use the R package
                    <em>
                        recommenderlab
                    </em>
                    .  I create a binary matrix from the transactions object in the market basket analysis.  I use this binary matrix to create the evaluation scheme by executing a split test with 1 fold using 90% of the samples for training with 3 items as given.  I built a list of recommendation algorithms which can work with a binary matrix.   These include:
                </p>
                <ul>
                    <li>
                        Random (used as the baseline)
                    </li>
                    <li>
                        Association Rules
                    </li>
                    <li>
                        Popular
                    </li>
                    <li>
                        Item Based Collaborative Filter
                    </li>
                    <li>
                        User Based Collaborative Filter
                    </li>
                </ul>
                <p>
                    The algorithms are evaluated by looking at the top N items for 1,3,5,10,15,20 product recommendation.   The evaluation routine computes the confusion matrix for each algorithm.
                </p>
                <h3>
                    Recommendation algorithm evaluation
                </h3>
                <p>
                    <img alt="rfm heat map" data-canonical-url="https://drive.google.com/uc?export=view&amp;id=0B_LVBjTSvf5rcmktbTNzdzkzRVk&amp;authuser=0" src="https://res.cloudinary.com/devpost/image/fetch/s--gYoIpRjg--/c_limit,f_auto,fl_lossy,q_auto:eco,w_900/https://drive.google.com/uc%3Fexport%3Dview%26id%3D0B_LVBjTSvf5rcmktbTNzdzkzRVk%26authuser%3D0">
                </p>
                <p>
                    This graph shows the results from the recommendation algorithms evaluation.   It plots the True Positive Rate (TPR) and False Positive Rates (FPR) for each of the algorithms.   For the first five recommended items, three algorithms appear to be equal, Popular, Association Rules (AR), and User-Based Collaborative Filter (UBCF).   As you starting increasing the number of items in the recommendation suggestions, separation starts to occur after 10 items.   The Item-Based Collaborative Filter (IBCF) algorithm stopped after ten items.
                </p>
                <h2>
                    Challenges and Learning Experiences
                </h2>
                <p>
                    I bumped up against the 5 GB upload limit to Object Storage on Bluemix.   In order to upload the 20 GB transaction data, I needed to use the Swift CLI and upload the file by setting segment sizes which could not exceed 5 GB.  I needed to install all the necessary python packages and their dependencies and figure out all the authentication settings to move the file into my Bluemix environment.   SparkR on Bluemix did have an elegant method to access the data once all the segments were upload.
                </p>
                <p>
                    <code>
                        transactions &lt;- read.df(sqlContext,"swift://notebooks.spark/transactions.csv",source = "com.databricks.spark.csv", header="true", inferSchema = "true")
                    </code>
                </p>
                <p>
                    Another challenge I ran into was trying to use the new R Studio package,
                    <em>
                        sparklyr
                    </em>
                    , to connect to Spark on Bluemix.  JJ Allaire spoke about this package at the the Apache Spark Maker Community Event. It would have been nice to use this package and keep the development within one IDE.   For this challenge, I needed to use two IDEs.  Notebook for SparkR on Bluemix for the spark data and R Studio on my local machine for the visualizations.
                </p>
                <p>
                    My key learning experience with this challenge is knowing how to build a market basket analysis with association rules.   It is a subject which I've read material, but having large data set to execute the analysis and dive in deep to the rich R packages around association rules was worthwhile.
                </p>
                <h2>
                    What's Next
                </h2>
                <p>
                    This application lays the foundation to build an enhanced customer relationship.   The RFM analysis creates your customer segments.   The market basket analysis shows related purchased products.   This can be used to bundle products in store displays, inform your online customers "Customers Who Bought This Item Also Bought", or create marketing programs for suppliers.   Recommendation algorithm evaluation gives you the direction to begin creating customer product recommendations.
                </p>
                <p>
                    <img alt="App customer" data-canonical-url="https://drive.google.com/uc?export=view&amp;id=0B_LVBjTSvf5rQ2tMNVRGZ3gwYzA&amp;authuser=0" src="https://res.cloudinary.com/devpost/image/fetch/s--dg65uJ1G--/c_limit,f_auto,fl_lossy,q_auto:eco,w_900/https://drive.google.com/uc%3Fexport%3Dview%26id%3D0B_LVBjTSvf5rQ2tMNVRGZ3gwYzA%26authuser%3D0">
                </p>
                <p>
                    Now you know the customer's transaction history and have put it into a context.
                </p>
                <blockquote>
                    <h3>
                        However, transaction data alone does not tell much about your customer's needs.
                        <em>
                            The next step is to layer the data from your mobile app affinity program on top of your transaction data
                        </em>
                        .
                    </h3>
                </blockquote>
                <p>
                    This will allow you to build an analytics platform which creates personalized customer experiences and predictive insights to help you stay on top of fast moving consumer trends.  Successful execution will not only enhance your customer relationships, but integrate the relationship as a part of your best customers lifestyle.
                </p>
            </div>
            <div class="" id="built-with">
                <h2>
                    Built With
                </h2>
                <ul class="no-bullet inline-list">
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/bluemix">
                                bluemix
                            </a>
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/r">
                                r
                            </a>
                        </span>
                    </li>
                </ul>
            </div>
            <nav class="app-links section">
                <h2>
                    Try it out
                </h2>
                <ul class="no-bullet" data-role="software-urls">
                    <li>
                        <a href="https://rpubs.com/robcamp/affinity" rel="nofollow" target="_blank" title="https://rpubs.com/robcamp/affinity">
                            <i class="ss-icon ss-link">
                            </i>
                            <span>
                                rpubs.com
                            </span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </body>
</html>
