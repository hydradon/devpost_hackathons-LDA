<html>
    <head>
    </head>
    <body>
        <div class="large-9 columns" id="app-details-left">
            <div id="gallery">
                <ul>
                    <li>
                        <div class="flex-video">
                            <iframe allowfullscreen="allowfullscreen" allowscriptaccess="always" class="video-embed" frameborder="0" height="371" mode="transparent" src="https://www.youtube.com/embed/o75O4ZwzOyc?enablejsapi=1&amp;hl=en_US&amp;rel=0&amp;start=&amp;version=3&amp;wmode=transparent" type="text/html" webkitallowfullscreen="true" width="660" wmode="transparent">
                            </iframe>
                        </div>
                    </li>
                    <li class="text-center">
                        <a data-lightbox="679823" data-title="Skill architecture" href="https://challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/679/823/datas/original.png">
                            <img alt="language teacher &ndash; screenshot 1" class="software_photo_image image-replacement" onerror="this.onerror=null;this.src='https://devpost-challengepost.netdna-ssl.com/assets/defaults/thumbnail-placeholder-42bcab8d8178b413922ae2877d8b0868.gif';" src="//challengepost-s3-challengepost.netdna-ssl.com/photos/production/software_photos/000/679/823/datas/gallery.jpg">
                        </a>
                        <span class="expand-tag">
                            <i class="fas fa-expand">
                            </i>
                        </span>
                        <p>
                            <i>
                                Skill architecture
                            </i>
                        </p>
                    </li>
                </ul>
            </div>
            <div>
                <h2>
                    Building "Language Teacher" -  Alexa skill powered by AWS Polly and AWS Translate
                </h2>
                <p>
                    Building Alexa skills is a fun. It's even more interesting once you acknowledge the vast amount of AWS services which could be easily integrated with Lambda function. My recent experiment was to build something interesting that can use best of both Alexa and AWS worlds, so I came up with this idea to use AWS Polly and AWS Translate to give Alexa accustomed VUI a new spin.
                </p>
                <h2>
                    Test drive
                </h2>
                <p>
                    "Language teacher" has recently passed the certification and has been published by Amazon. Currently the skill can talk back to you in 7 languages: Russian, Italian, French, German, Portuguese, Japanese, Spanish and output the transcription of the speech to your Alexa app:
Give it a test drive to see how it works:
                    <a href="https://www.amazon.com/dp/B07GYS433J/" rel="nofollow">
                        https://www.amazon.com/dp/B07GYS433J/
                    </a>
                </p>
                <h2>
                    Skill Architecture
                </h2>
                <p>
                    Here is how the architecture of the skill looks like:
                </p>
                <p>
                    <strong>
                        <em>
                            Step 1
                        </em>
                    </strong>
                    - User activates Echo device by using Alexa skill invocation name "language teacher" with any of available intent utterances
                </p>
                <p>
                    <strong>
                        <em>
                            Step 2
                        </em>
                    </strong>
                    - Echo device sends the request as an audio to Alexa Voice Service, where AVS through it's ASR &amp; NLU capability recognizes the skill and intent names
                </p>
                <p>
                    <strong>
                        <em>
                            Step 3
                        </em>
                    </strong>
                    - Alexa Voice Service invokes a particular skill endpoint which in our case is defined as AWS Lambda function ARN. In the request to Lambda AVS passes an identified intent name with all the derived slot values from the Step 2
                </p>
                <p>
                    <strong>
                        <em>
                            Step 4
                        </em>
                    </strong>
                    - Lambda function takes the Device ID from the request and goes to Dynamo DB table to check if the User has defined his preferred translation language before, if language has not been defined it will use a default language
                </p>
                <p>
                    <strong>
                        <em>
                            Step 5
                        </em>
                    </strong>
                    - The slot value and a language code are passed by Lambda to AWS Translate as parameters. AWS Translate returns a translated text in the response
                </p>
                <p>
                    <strong>
                        <em>
                            Step 6
                        </em>
                    </strong>
                    - Lambda takes AWS Translate response and passes it to AWS Polly along with the Voice ID that should be used to produce the speech from the text. AWS Polly returns a stream to the Lambda function in a response
                </p>
                <p>
                    <strong>
                        <em>
                            Step 7
                        </em>
                    </strong>
                    - Lambda writes the stream as an mp3 file to S3 bucket with the prefix as a hashed Device ID
                </p>
                <p>
                    <strong>
                        <em>
                            Step 8
                        </em>
                    </strong>
                    - Lambda prepares the response using SSML audio tag to reference the audio file location and sends it back to AVS
                </p>
                <p>
                    <strong>
                        <em>
                            Step 9
                        </em>
                    </strong>
                    - AVS sends the response to the Echo device
                </p>
                <p>
                    <strong>
                        <em>
                            Step 10 and 11
                        </em>
                    </strong>
                    - Echo device produces the response back to the User with audio file being streamed as part of the response
                </p>
                <h2>
                    Skill Implementation
                </h2>
                <p>
                    The implementation part is quite straight forward, for the full version and interaction model you can check out the source code here:
                    <a href="https://github.com/Dlozitskiy/language-teacher/" rel="nofollow">
                        https://github.com/Dlozitskiy/language-teacher/
                    </a>
                    As our lambda is dealing with asynchronous calls, the intent code has been structured as a chain of promises:
                </p>
                <p>
                    <strong>
                        <em>
                            Translate:
                        </em>
                    </strong>
                </p>
                <pre class="language-javascript"><code>function doTranslate(text,language) {
        let result = new Promise((resolve, reject) =&gt; {
        var inputText = text;
        var params = {
        Text: inputText,
        SourceLanguageCode: 'en',
        TargetLanguageCode: language
        };
        translate.translateText(params, function(err, data) {
        if (err) {
        console.error(err, err.stack); // an error occurred
        reject(err);
        }
        else {
        console.log(data);           // successful response
        resolve(data.TranslatedText);
        }
        });
  });
  return result;
}
</code></pre>
                <p>
                    <strong>
                        <em>
                            Synthesize:
                        </em>
                    </strong>
                </p>
                <pre class="language-javascript"><code>function doSynthesize(text,voice) {
        let result = new Promise((resolve, reject) =&gt; {
        var params = {
        OutputFormat: "mp3",
        SampleRate: "22050",
        Text: `&lt;speak&gt;&lt;amazon:effect name="drc"&gt;&lt;p&gt;${text}&lt;/p&gt;&lt;/amazon:effect&gt;
        &lt;prosody rate="slow"&gt;&lt;amazon:effect name="drc"&gt;&lt;p&gt;${text}&lt;/p&gt;&lt;/amazon:effect&gt;&lt;/prosody&gt;&lt;/speak&gt;`,
        TextType: "ssml",
        VoiceId: voice
        };
        polly.synthesizeSpeech(params, function(err, data) {
        if (err) {
        console.error(err, err.stack); // an error occurred
        reject(err);
        }
        else {
        resolve(data.AudioStream);
        }
        });
  });
  return result;
}
</code></pre>
                <p>
                    <strong>
                        <em>
                            Write to S3:
                        </em>
                    </strong>
                </p>
                <pre class="language-javascript"><code>function writeToS3(data,prefix) {
        let result = new Promise((resolve, reject) =&gt; {
        var putParams = {
        Bucket: `${process.env.BUCKET}`,
        Key: `${prefix}/speech.mp3`,
        Body: data,
        ACL: 'public-read',
        StorageClass: 'REDUCED_REDUNDANCY'
        };
        console.log('Uploading to S3');
        s3.putObject(putParams, function (putErr, putData) {
        if (putErr) {
        console.error(putErr);
        reject(putErr);
        } else {
        resolve(putData);
        }
        });
  });
</code></pre>
                <p>
                    <strong>
                        <em>
                            Building the response:
                        </em>
                    </strong>
                </p>
                <pre class="language-javascript"><code>
                return new Promise((resolve) =&gt; {
                doTranslate(phrase, sessionAttributes.targetLanguage)
                .then((data) =&gt; {
                translation = data;
                doSynthesize(data, voices[sessionAttributes.targetLanguage])
                .then((data) =&gt; {
                writeToS3(data,prefix)
                .then(() =&gt; {
                console.log(prefix);
                resolve(handlerInput.responseBuilder
                .speak(`This is how phrase ${phrase} will sound in ${languages[sessionAttributes.targetLanguage]}:\
                &lt;audio src="https://s3.amazonaws.com/${process.env.BUCKET}/${prefix}/speech.mp3"/&gt;\
                Say "repeat" to listen again, or ask something else to get a new translation`)
                .reprompt('Say "repeat" to listen again, or ask something else to get a new translation')
                .withStandardCard(
                'Language Teacher',
                `Original phrase: ${phrase}\nTranslation in ${languages[sessionAttributes.targetLanguage]}: ${translation}`,
                card_small,
                card_big)
                .getResponse());
                });
                });
                });
    });
  },
};
</code></pre>
                <p>
                    For hashing of an Echo Device ID as an S3 object prefix, you can use md5 hash function:
                </p>
                <pre class="language-javascript"><code>const devId = handlerInput.requestEnvelope.context.System.device.deviceId;    
const prefix = require('crypto').createHash('md5').update(devId).digest("hex").toString();
</code></pre>
                <h2>
                    What's next
                </h2>
                <p>
                    Currently the skill just went live and it's gathering a feedback from the customers on what can be improved in the future releases, there might be an option to learn poems in different languages repeating after native speakers or learning famous saying by famous people in their native languages!
                </p>
            </div>
            <div class="" id="built-with">
                <h2>
                    Built With
                </h2>
                <ul class="no-bullet inline-list">
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/amazon-alexa">
                                amazon-alexa
                            </a>
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            amazon-polly
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            amazon-translate
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            aws-polly
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag">
                            aws-translate
                        </span>
                    </li>
                    <li>
                        <span class="cp-tag recognized-tag">
                            <a href="https://devpost.com/software/built-with/javascript">
                                javascript
                            </a>
                        </span>
                    </li>
                </ul>
            </div>
            <nav class="app-links section">
                <h2>
                    Try it out
                </h2>
                <ul class="no-bullet" data-role="software-urls">
                    <li>
                        <a href="https://github.com/Dlozitskiy/language-teacher" rel="nofollow" target="_blank" title="https://github.com/Dlozitskiy/language-teacher">
                            <i class="ss-icon ss-link">
                            </i>
                            <span>
                                github.com
                            </span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </body>
</html>
