[
    {
        "url": "https://api.github.com/repos/prometheus-ai/fb-messenger-clj/pulls/comments/107984205",
        "pull_request_review_id": 28993575,
        "id": 107984205,
        "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwNzk4NDIwNQ==",
        "diff_hunk": "@@ -1,24 +1,89 @@\n (ns fb-messenger.send\n   (:require\n-    [clj-http.client :as client]))\n+    [clojure.data.json :as json]\n+    [org.httpkit.client :as http]))\n \n (def ^:dynamic *base-url* \"https://graph.facebook.com/v2.6\")\n-(def ^:dynamic *token* nil)\n+(def ^:dynamic *page-access-token* nil)\n \n (defn set-base-url!\n   [base-url]\n   (alter-var-root #'*base-url* (constantly base-url)))\n \n (defn set-token!\n   [token]\n-  (alter-var-root #'*token* (constantly token)))\n-\n-(defn send-text-message\n-  ([recipient-id text]\n-   (send-text-message *base-url* *token* recipient-id text))\n-  ([base-url token recipient-id text]\n-   (client/post\n-    (str base-url \"/me/messages?access_token=\" token)\n-    {:form-params\n-      {:recipient {:id recipient-id}, :message {:text text}\n-       :content-type :json}})))\n+  (alter-var-root #'*page-access-token* (constantly token)))\n+\n+(defn- handle-facebook-response [response]\n+  (if (= (:status response) 200)\n+    (json/read-str (:body response) :key-fn keyword)\n+    (println (str \"Facebook error response \" (:body response)))))\n+\n+(defn- post-api\n+  [endpoint body page-access-token]\n+  (let [response @(http/post (str *base-url* \"/\" endpoint)\n+                             {:query-params {\"access_token\" page-access-token}\n+                              :headers      {\"Content-Type\" \"application/json\"}\n+                              :body         (json/write-str body)\n+                              :insecure?    true})]\n+    (handle-facebook-response response)))\n+\n+(defn send-message\n+  \"sends Message to PSID via FB Send Api, see:\n+   https://developers.facebook.com/docs/messenger-platform/send-api-reference\"\n+  ([psid message]\n+   (send-message psid *page-access-token*))\n+  ([psid message page-access-token]\n+   (post-api \"me/messages\" {:recipient {:id psid}\n+                            :message   message})))\n+\n+(defn send-sender-action\n+  \"send Sender Action to PSID via FB Send Api, see:\n+   https://developers.facebook.com/docs/messenger-platform/send-api-reference/sender-actions\"\n+  ([psid sender-action]\n+   (send-sender-action *page-access-token*))\n+  ([psid sender-action page-access-token]\n+   (post-api \"me/messages\" {:recipient     {:id psid}\n+                            :sender_action sender-action})))\n+\n+(defn upload-attachment\n+  \"uploads Attachment via FB Upload API and returns body containing :attachment_id, see:\n+   https://developers.facebook.com/docs/messenger-platform/send-api-reference/attachment-upload/v2.8\"\n+  ([type url]\n+   (upload-attachment type url *page-access-token*))\n+  ([type url page-access-token]\n+   (post-api \"me/message_attachments\"\n+            {:message {:attachment {:type    type\n+                                    :payload {:url         url\n+                                              :is_reusable true}}}})))\n+\n+(defn set-messenger-profile\n+  \"sets messenger profile data, see:\n+   https://developers.facebook.com/docs/messenger-platform/messenger-profile\"\n+  ([profile]\n+   (set-messenger-profile profile *page-access-token*))\n+  ([profile page-access-token]\n+   (post-api \"me/messenger_profile\" profile)))\n+\n+(defn get-user-profile\n+  \"gets user profile data for PSID, see:\n+   https://developers.facebook.com/docs/messenger-platform/user-profile\"\n+  ([psid]\n+   (get-user-profile psid *page-access-token*))\n+  ([psid page-access-token]\n+   (let [response @(http/get (str *base-url* \"/\" psid)\n+                            {:query-params {:access_token page-access-token\n+                                            :fields       \"first_name,last_name,profile_pic,locale,timezone,gender\"}\n+                             :headers       {\"Content-Type\" \"application/json\"}\n+                             :insecure?     true})]\n+    (handle-facebook-response response))))\n+\n+(defn handle-webhook",
        "path": "src/fb_messenger/send.clj",
        "position": null,
        "original_position": 94,
        "commit_id": "a49421257c25250af227c26b8d5b90923eafa4f3",
        "original_commit_id": "8682231dd5ace457bcef7c63f0195252a44cfbb7",
        "user": {
            "login": "Sgoettschkes",
            "id": 628796,
            "node_id": "MDQ6VXNlcjYyODc5Ng==",
            "avatar_url": "https://avatars1.githubusercontent.com/u/628796?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/Sgoettschkes",
            "html_url": "https://github.com/Sgoettschkes",
            "followers_url": "https://api.github.com/users/Sgoettschkes/followers",
            "following_url": "https://api.github.com/users/Sgoettschkes/following{/other_user}",
            "gists_url": "https://api.github.com/users/Sgoettschkes/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/Sgoettschkes/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/Sgoettschkes/subscriptions",
            "organizations_url": "https://api.github.com/users/Sgoettschkes/orgs",
            "repos_url": "https://api.github.com/users/Sgoettschkes/repos",
            "events_url": "https://api.github.com/users/Sgoettschkes/events{/privacy}",
            "received_events_url": "https://api.github.com/users/Sgoettschkes/received_events",
            "type": "User",
            "site_admin": false
        },
        "body": "Would it make sense to put this function into it's own namespace as it's more related to receiving than sending?",
        "created_at": "2017-03-24T19:38:00Z",
        "updated_at": "2017-04-11T19:41:17Z",
        "html_url": "https://github.com/prometheus-ai/fb-messenger-clj/pull/1#discussion_r107984205",
        "pull_request_url": "https://api.github.com/repos/prometheus-ai/fb-messenger-clj/pulls/1",
        "author_association": "CONTRIBUTOR",
        "_links": {
            "self": {
                "href": "https://api.github.com/repos/prometheus-ai/fb-messenger-clj/pulls/comments/107984205"
            },
            "html": {
                "href": "https://github.com/prometheus-ai/fb-messenger-clj/pull/1#discussion_r107984205"
            },
            "pull_request": {
                "href": "https://api.github.com/repos/prometheus-ai/fb-messenger-clj/pulls/1"
            }
        }
    },
    {
        "url": "https://api.github.com/repos/prometheus-ai/fb-messenger-clj/pulls/comments/108034644",
        "pull_request_review_id": 29045928,
        "id": 108034644,
        "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwODAzNDY0NA==",
        "diff_hunk": "@@ -1,24 +1,89 @@\n (ns fb-messenger.send\n   (:require\n-    [clj-http.client :as client]))\n+    [clojure.data.json :as json]\n+    [org.httpkit.client :as http]))\n \n (def ^:dynamic *base-url* \"https://graph.facebook.com/v2.6\")\n-(def ^:dynamic *token* nil)\n+(def ^:dynamic *page-access-token* nil)\n \n (defn set-base-url!\n   [base-url]\n   (alter-var-root #'*base-url* (constantly base-url)))\n \n (defn set-token!\n   [token]\n-  (alter-var-root #'*token* (constantly token)))\n-\n-(defn send-text-message\n-  ([recipient-id text]\n-   (send-text-message *base-url* *token* recipient-id text))\n-  ([base-url token recipient-id text]\n-   (client/post\n-    (str base-url \"/me/messages?access_token=\" token)\n-    {:form-params\n-      {:recipient {:id recipient-id}, :message {:text text}\n-       :content-type :json}})))\n+  (alter-var-root #'*page-access-token* (constantly token)))\n+\n+(defn- handle-facebook-response [response]\n+  (if (= (:status response) 200)\n+    (json/read-str (:body response) :key-fn keyword)\n+    (println (str \"Facebook error response \" (:body response)))))\n+\n+(defn- post-api\n+  [endpoint body page-access-token]\n+  (let [response @(http/post (str *base-url* \"/\" endpoint)\n+                             {:query-params {\"access_token\" page-access-token}\n+                              :headers      {\"Content-Type\" \"application/json\"}\n+                              :body         (json/write-str body)\n+                              :insecure?    true})]\n+    (handle-facebook-response response)))\n+\n+(defn send-message\n+  \"sends Message to PSID via FB Send Api, see:\n+   https://developers.facebook.com/docs/messenger-platform/send-api-reference\"\n+  ([psid message]\n+   (send-message psid *page-access-token*))\n+  ([psid message page-access-token]\n+   (post-api \"me/messages\" {:recipient {:id psid}\n+                            :message   message})))\n+\n+(defn send-sender-action\n+  \"send Sender Action to PSID via FB Send Api, see:\n+   https://developers.facebook.com/docs/messenger-platform/send-api-reference/sender-actions\"\n+  ([psid sender-action]\n+   (send-sender-action *page-access-token*))\n+  ([psid sender-action page-access-token]\n+   (post-api \"me/messages\" {:recipient     {:id psid}\n+                            :sender_action sender-action})))\n+\n+(defn upload-attachment\n+  \"uploads Attachment via FB Upload API and returns body containing :attachment_id, see:\n+   https://developers.facebook.com/docs/messenger-platform/send-api-reference/attachment-upload/v2.8\"\n+  ([type url]\n+   (upload-attachment type url *page-access-token*))\n+  ([type url page-access-token]\n+   (post-api \"me/message_attachments\"\n+            {:message {:attachment {:type    type\n+                                    :payload {:url         url\n+                                              :is_reusable true}}}})))\n+\n+(defn set-messenger-profile\n+  \"sets messenger profile data, see:\n+   https://developers.facebook.com/docs/messenger-platform/messenger-profile\"\n+  ([profile]\n+   (set-messenger-profile profile *page-access-token*))\n+  ([profile page-access-token]\n+   (post-api \"me/messenger_profile\" profile)))\n+\n+(defn get-user-profile\n+  \"gets user profile data for PSID, see:\n+   https://developers.facebook.com/docs/messenger-platform/user-profile\"\n+  ([psid]\n+   (get-user-profile psid *page-access-token*))\n+  ([psid page-access-token]\n+   (let [response @(http/get (str *base-url* \"/\" psid)\n+                            {:query-params {:access_token page-access-token\n+                                            :fields       \"first_name,last_name,profile_pic,locale,timezone,gender\"}\n+                             :headers       {\"Content-Type\" \"application/json\"}\n+                             :insecure?     true})]\n+    (handle-facebook-response response))))\n+\n+(defn handle-webhook",
        "path": "src/fb_messenger/send.clj",
        "position": null,
        "original_position": 94,
        "commit_id": "a49421257c25250af227c26b8d5b90923eafa4f3",
        "original_commit_id": "8682231dd5ace457bcef7c63f0195252a44cfbb7",
        "user": {
            "login": "sido378",
            "id": 2779625,
            "node_id": "MDQ6VXNlcjI3Nzk2MjU=",
            "avatar_url": "https://avatars0.githubusercontent.com/u/2779625?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/sido378",
            "html_url": "https://github.com/sido378",
            "followers_url": "https://api.github.com/users/sido378/followers",
            "following_url": "https://api.github.com/users/sido378/following{/other_user}",
            "gists_url": "https://api.github.com/users/sido378/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/sido378/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/sido378/subscriptions",
            "organizations_url": "https://api.github.com/users/sido378/orgs",
            "repos_url": "https://api.github.com/users/sido378/repos",
            "events_url": "https://api.github.com/users/sido378/events{/privacy}",
            "received_events_url": "https://api.github.com/users/sido378/received_events",
            "type": "User",
            "site_admin": false
        },
        "body": "yes,an own namespace is definitly appropriate. see latest commit",
        "created_at": "2017-03-25T12:01:04Z",
        "updated_at": "2017-04-11T19:41:17Z",
        "html_url": "https://github.com/prometheus-ai/fb-messenger-clj/pull/1#discussion_r108034644",
        "pull_request_url": "https://api.github.com/repos/prometheus-ai/fb-messenger-clj/pulls/1",
        "author_association": "CONTRIBUTOR",
        "_links": {
            "self": {
                "href": "https://api.github.com/repos/prometheus-ai/fb-messenger-clj/pulls/comments/108034644"
            },
            "html": {
                "href": "https://github.com/prometheus-ai/fb-messenger-clj/pull/1#discussion_r108034644"
            },
            "pull_request": {
                "href": "https://api.github.com/repos/prometheus-ai/fb-messenger-clj/pulls/1"
            }
        },
        "in_reply_to_id": 107984205
    }
]